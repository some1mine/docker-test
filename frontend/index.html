<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>아이템 관리</title>
    <!-- 부트스트랩 CSS CDN 링크 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 부트스트랩 JS 및 Popper.js CDN 링크 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            padding-top: 4.5rem;
        }
        .container {
            max-width: 720px;
        }
    </style>
</head>
<body>
    <!-- 네비게이션 바 -->
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">아이템 관리 시스템</a>
        </div>
    </nav>

    <main class="container">
        <!-- 아이템 등록 섹션 -->
        <div class="my-4 p-5 bg-light rounded-3">
            <h1 class="display-5">새 아이템 등록</h1>
            <p class="lead">아래 양식을 사용하여 새로운 아이템을 추가하세요.</p>
            <!-- 아이템 등록 폼 -->
            <form id="addItemForm">
                <div class="mb-3">
                    <label for="itemName" class="form-label">아이템 이름</label>
                    <input type="text" class="form-control" id="itemName" placeholder="예: 신라면" required>
                </div>
                <button type="submit" class="btn btn-primary">등록하기</button>
            </form>
        </div>

        <!-- 아이템 목록 섹션 -->
        <div class="mt-5">
            <h2>등록된 아이템 목록</h2>
            <p>현재 데이터베이스에 저장된 아이템들의 목록입니다.</p>
            <!-- 아이템 목록이 표시될 테이블 -->
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">이름</th>
                    </tr>
                </thead>
                <tbody id="itemsList">
                    <!-- 자바스크립트를 통해 동적으로 내용이 채워집니다. -->
                </tbody>
            </table>
        </div>
    </main>

    
    <script>
        // DOM이 완전히 로드된 후 스크립트 실행
        document.addEventListener('DOMContentLoaded', function () {
            const addItemForm = document.getElementById('addItemForm');
            const itemNameInput = document.getElementById('itemName');
            const itemsList = document.getElementById('itemsList');

            // 기능: 서버로부터 모든 아이템을 가져와 화면에 표시
            async function fetchItems() {
                try {
                    // '/items' GET API 호출
                    const response = await fetch('/api/items');
                    if (!response.ok) {
                        throw new Error('서버에서 아이템을 가져오는 데 실패했습니다.');
                    }
                    const data = await response.json();
                    
                    // 목록 초기화
                    itemsList.innerHTML = '';

                    // 가져온 아이템들을 테이블에 추가 (성능 최적화)
                    let rowsHtml = '';
                    if (data.items && data.items.length > 0) {
                        // 1. 모든 행의 HTML을 하나의 문자열로 만듭니다.
                        data.items.forEach(item => {
                            rowsHtml += `<tr>
                                           <td>${item[0]}</td>
                                           <td>${item[1]}</td>
                                        </tr>`;
                        });
                    } else {
                        // 2. 아이템이 없을 경우 표시할 메시지입니다.
                        rowsHtml = '<tr><td colspan="2" class="text-center">등록된 아이템이 없습니다.</td></tr>';
                    }
                    // 3. 최종적으로 생성된 HTML 문자열을 DOM에 한 번만 할당합니다.
                    itemsList.innerHTML = rowsHtml;
                } catch (error) {
                    console.error('아이템 로딩 중 오류 발생:', error);
                    alert(error.message);
                }
            }

            // 기능: 새 아이템을 서버에 등록
            async function addItem(name) {
                try {
                    // '/items' POST API 호출 (쿼리 파라미터로 이름 전달)
                    const response = await fetch(`/api/items?name=${encodeURIComponent(name)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('아이템 등록에 실패했습니다.');
                    }

                    const result = await response.json();
                    console.log(result.message); // 서버로부터 받은 메시지 콘솔에 출력

                    // 등록 성공 후, 입력 필드 비우고 목록 새로고침
                    itemNameInput.value = '';
                    fetchItems();

                } catch (error) {
                    console.error('아이템 등록 중 오류 발생:', error);
                    alert(error.message);
                }
            }

            // 폼 제출 이벤트 리스너
            addItemForm.addEventListener('submit', function (event) {
                event.preventDefault(); // 폼의 기본 제출 동작 방지
                const itemName = itemNameInput.value.trim(); // 입력값의 양쪽 공백 제거

                if (itemName) {
                    addItem(itemName);
                } else {
                    alert('아이템 이름을 입력해주세요.');
                }
            });

            // 페이지 로드 시 아이템 목록을 가져옴
            fetchItems();
        });
    </script>
</body>
</html>
